<!-- ============================================
     SECCIÓN ADICIONAL PARA EL PANEL DE ADMINISTRACIÓN
     AGREGAR ESTE TAB AL ARCHIVO admin.html
     ============================================ -->

<!-- En el <div class="nav-tabs">, agregar este botón: -->
<button class="nav-tab" onclick="showAdminTab('delivery-apps')">
    <i class="fas fa-motorcycle"></i> Repartidores
</button>

<!-- Después del último tab-content, agregar esta sección: -->

<!-- Tab Gestión de Repartidores -->
<div id="delivery-apps-tab" class="tab-content">
    <h2><i class="fas fa-motorcycle"></i> Gestión de Repartidores</h2>
    
    <!-- Sub-tabs -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
        <button class="btn btn-primary" onclick="showDeliverySubTab('applications')" id="btnApplications">
            <i class="fas fa-inbox"></i> Solicitudes Pendientes
        </button>
        <button class="btn btn-secondary" onclick="showDeliverySubTab('codes')" id="btnCodes">
            <i class="fas fa-ticket-alt"></i> Códigos de Invitación
        </button>
        <button class="btn btn-secondary" onclick="showDeliverySubTab('history')" id="btnHistory">
            <i class="fas fa-history"></i> Historial
        </button>
    </div>

    <!-- Sub-tab: Solicitudes Pendientes -->
    <div id="sub-applications" class="delivery-sub-tab active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3><i class="fas fa-clipboard-list"></i> Solicitudes de Registro</h3>
            <button class="btn btn-success" onclick="loadDeliveryApplications()">
                <i class="fas fa-sync"></i> Actualizar
            </button>
        </div>
        
        <div id="applicationsList">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Cargando solicitudes...
            </div>
        </div>
    </div>

    <!-- Sub-tab: Códigos de Invitación -->
    <div id="sub-codes" class="delivery-sub-tab">
        <h3><i class="fas fa-plus-circle"></i> Generar Código de Invitación</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Los códigos de invitación permiten a nuevos repartidores registrarse en el sistema. 
            Cada código es válido por 30 días y solo puede usarse una vez.
        </p>
        
        <button class="btn btn-success" onclick="generateNewCode()">
            <i class="fas fa-key"></i> Generar Nuevo Código
        </button>
        
        <div id="newCodeResult" style="margin-top: 20px;"></div>
        
        <hr style="margin: 30px 0;">
        
        <h3><i class="fas fa-list"></i> Códigos Generados</h3>
        <div id="codesList"></div>
    </div>

    <!-- Sub-tab: Historial -->
    <div id="sub-history" class="delivery-sub-tab">
        <h3><i class="fas fa-history"></i> Historial de Solicitudes</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Todas las solicitudes procesadas (aprobadas y rechazadas)
        </p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="filterHistory('all')">Todas</button>
            <button class="btn btn-success" onclick="filterHistory('aprobada')">Aprobadas</button>
            <button class="btn btn-danger" onclick="filterHistory('rechazada')">Rechazadas</button>
        </div>
        
        <div id="historyList"></div>
    </div>
</div>

<!-- Modal de Detalle de Solicitud -->
<div id="applicationDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-check"></i> Detalle de Solicitud</h3>
            <button class="close-modal" onclick="closeApplicationDetail()">×</button>
        </div>
        
        <div id="applicationDetailContent"></div>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h4><i class="fas fa-clipboard-check"></i> Acciones</h4>
            
            <div id="approveSection" class="action-section">
                <h5 style="color: #28a745;">
                    <i class="fas fa-check-circle"></i> Aprobar Solicitud
                </h5>
                <div class="form-group">
                    <label>Asignar Contraseña Temporal</label>
                    <input type="password" id="tempPassword" placeholder="Mínimo 6 caracteres">
                    <small>El repartidor podrá cambiarla después</small>
                </div>
                <button class="btn btn-success" onclick="approveApplication()">
                    <i class="fas fa-check"></i> Aprobar y Crear Usuario
                </button>
            </div>
            
            <hr style="margin: 20px 0;">
            
            <div id="rejectSection" class="action-section">
                <h5 style="color: #dc3545;">
                    <i class="fas fa-times-circle"></i> Rechazar Solicitud
                </h5>
                <div class="form-group">
                    <label>Motivo del Rechazo</label>
                    <textarea id="rejectReason" rows="3" placeholder="Especifica el motivo del rechazo..."></textarea>
                </div>
                <button class="btn btn-danger" onclick="rejectApplication()">
                    <i class="fas fa-times"></i> Rechazar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================
     JAVASCRIPT PARA GESTIÓN DE REPARTIDORES
     AGREGAR ESTE CÓDIGO AL FINAL DE admin.js
     ============================================ -->

<script>
// Variables globales
let currentApplication = null;
let allApplications = [];

// ============================================
// NAVEGACIÓN ENTRE SUB-TABS
// ============================================

function showDeliverySubTab(tab) {
    // Ocultar todos los sub-tabs
    document.querySelectorAll('.delivery-sub-tab').forEach(t => {
        t.classList.remove('active');
        t.style.display = 'none';
    });
    
    // Resetear botones
    document.getElementById('btnApplications').classList.remove('btn-primary');
    document.getElementById('btnApplications').classList.add('btn-secondary');
    document.getElementById('btnCodes').classList.remove('btn-primary');
    document.getElementById('btnCodes').classList.add('btn-secondary');
    document.getElementById('btnHistory').classList.remove('btn-primary');
    document.getElementById('btnHistory').classList.add('btn-secondary');
    
    // Mostrar el sub-tab seleccionado
    if(tab === 'applications') {
        document.getElementById('sub-applications').classList.add('active');
        document.getElementById('sub-applications').style.display = 'block';
        document.getElementById('btnApplications').classList.remove('btn-secondary');
        document.getElementById('btnApplications').classList.add('btn-primary');
        loadDeliveryApplications();
    } else if(tab === 'codes') {
        document.getElementById('sub-codes').classList.add('active');
        document.getElementById('sub-codes').style.display = 'block';
        document.getElementById('btnCodes').classList.remove('btn-secondary');
        document.getElementById('btnCodes').classList.add('btn-primary');
        loadInvitationCodes();
    } else if(tab === 'history') {
        document.getElementById('sub-history').classList.add('active');
        document.getElementById('sub-history').style.display = 'block';
        document.getElementById('btnHistory').classList.remove('btn-secondary');
        document.getElementById('btnHistory').classList.add('btn-primary');
        loadApplicationHistory();
    }
}

// ============================================
// CARGAR SOLICITUDES PENDIENTES
// ============================================

async function loadDeliveryApplications() {
    showLoading(true);
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'getDeliveryApplications'
            })
        });
        
        const result = await response.json();
        
        if(result.success) {
            allApplications = result.applications;
            const pending = allApplications.filter(app => app.status === 'pendiente');
            displayApplications(pending);
        } else {
            document.getElementById('applicationsList').innerHTML = `
                <div class="alert alert-error">Error al cargar solicitudes: ${result.message}</div>
            `;
        }
    } catch(error) {
        document.getElementById('applicationsList').innerHTML = `
            <div class="alert alert-error">Error: ${error.message}</div>
        `;
    } finally {
        showLoading(false);
    }
}

function displayApplications(applications) {
    const container = document.getElementById('applicationsList');
    
    if(applications.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-check-circle"></i>
                No hay solicitudes pendientes
            </div>
        `;
        return;
    }
    
    container.innerHTML = applications.map(app => {
        const date = new Date(app.timestamp).toLocaleDateString('es-MX');
        
        return `
            <div class="order-item" style="cursor: pointer;" onclick="viewApplicationDetail('${app.applicationId}')">
                <div class="cart-item-header">
                    <h4>${app.fullName}</h4>
                    <span class="order-status status-new">Pendiente</span>
                </div>
                <div class="cart-item-details">
                    <strong>Usuario:</strong> ${app.username}<br>
                    <strong>Teléfono:</strong> ${app.phone}<br>
                    <strong>Email:</strong> ${app.email || 'No proporcionado'}<br>
                    <strong>Fecha:</strong> ${date}<br>
                    <strong>Código:</strong> ${app.invitationCode}
                </div>
                <button class="btn btn-primary" onclick="event.stopPropagation(); viewApplicationDetail('${app.applicationId}')">
                    <i class="fas fa-eye"></i> Ver Detalles
                </button>
            </div>
        `;
    }).join('');
}

// ============================================
// VER DETALLE DE SOLICITUD
// ============================================

function viewApplicationDetail(applicationId) {
    const app = allApplications.find(a => a.applicationId === applicationId);
    if(!app) return;
    
    currentApplication = app;
    
    const date = new Date(app.timestamp).toLocaleString('es-MX');
    
    document.getElementById('applicationDetailContent').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4><i class="fas fa-user"></i> Información Personal</h4>
                <p><strong>Nombre Completo:</strong> ${app.fullName}</p>
                <p><strong>Usuario:</strong> ${app.username}</p>
                <p><strong>Teléfono:</strong> ${app.phone}</p>
                <p><strong>Email:</strong> ${app.email || 'No proporcionado'}</p>
                <p><strong>Fecha de Solicitud:</strong> ${date}</p>
                <p><strong>Código de Invitación:</strong> ${app.invitationCode}</p>
            </div>
            <div>
                <h4><i class="fas fa-info-circle"></i> Estado</h4>
                <p><strong>Estado Actual:</strong> <span class="order-status status-new">${app.status}</span></p>
                ${app.reviewDate ? `<p><strong>Revisado:</strong> ${new Date(app.reviewDate).toLocaleString('es-MX')}</p>` : ''}
                ${app.reviewedBy ? `<p><strong>Por:</strong> ${app.reviewedBy}</p>` : ''}
                ${app.notes ? `<p><strong>Notas:</strong> ${app.notes}</p>` : ''}
            </div>
        </div>
        
        <hr style="margin: 20px 0;">
        
        <h4><i class="fas fa-folder-open"></i> Documentos Cargados</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
            <div class="document-card">
                <i class="fas fa-id-card" style="font-size: 2em; color: #667eea;"></i>
                <p><strong>Selfie con INE</strong></p>
                <a href="${app.documents.selfie}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="fas fa-external-link-alt"></i> Ver
                </a>
            </div>
            <div class="document-card">
                <i class="fas fa-id-card-alt" style="font-size: 2em; color: #667eea;"></i>
                <p><strong>Licencia</strong></p>
                <a href="${app.documents.license}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="fas fa-external-link-alt"></i> Ver
                </a>
            </div>
            <div class="document-card">
                <i class="fas fa-car" style="font-size: 2em; color: #667eea;"></i>
                <p><strong>Tarjeta Circulación</strong></p>
                <a href="${app.documents.vehicle}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="fas fa-external-link-alt"></i> Ver
                </a>
            </div>
            <div class="document-card">
                <i class="fas fa-shield-alt" style="font-size: 2em; color: #667eea;"></i>
                <p><strong>No Antecedentes</strong></p>
                <a href="${app.documents.background}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="fas fa-external-link-alt"></i> Ver
                </a>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <a href="${app.folderUrl}" target="_blank" class="btn btn-info">
                <i class="fas fa-folder"></i> Ver Carpeta Completa en Drive
            </a>
        </div>
    `;
    
    // Mostrar/ocultar secciones según el estado
    if(app.status === 'pendiente') {
        document.getElementById('approveSection').style.display = 'block';
        document.getElementById('rejectSection').style.display = 'block';
    } else {
        document.getElementById('approveSection').style.display = 'none';
        document.getElementById('rejectSection').style.display = 'none';
    }
    
    document.getElementById('applicationDetailModal').classList.add('active');
}

function closeApplicationDetail() {
    document.getElementById('applicationDetailModal').classList.remove('active');
    currentApplication = null;
}

// ============================================
// APROBAR SOLICITUD
// ============================================

async function approveApplication() {
    if(!currentApplication) return;
    
    const password = document.getElementById('tempPassword').value.trim();
    
    if(!password) {
        alert('Por favor asigna una contraseña temporal');
        return;
    }
    
    if(password.length < 6) {
        alert('La contraseña debe tener al menos 6 caracteres');
        return;
    }
    
    if(!confirm(`¿Aprobar la solicitud de ${currentApplication.fullName} y crear su cuenta de usuario?`)) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'approveDeliveryApplication',
                applicationId: currentApplication.applicationId,
                password: password,
                adminUsername: currentUser.username
            })
        });
        
        const result = await response.json();
        
        if(result.success) {
            alert(`✅ Solicitud aprobada. Usuario ${result.username} creado exitosamente.`);
            closeApplicationDetail();
            loadDeliveryApplications();
        } else {
            alert('Error: ' + result.message);
        }
    } catch(error) {
        alert('Error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// RECHAZAR SOLICITUD
// ============================================

async function rejectApplication() {
    if(!currentApplication) return;
    
    const reason = document.getElementById('rejectReason').value.trim();
    
    if(!reason) {
        alert('Por favor especifica el motivo del rechazo');
        return;
    }
    
    if(!confirm(`¿Rechazar la solicitud de ${currentApplication.fullName}?`)) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'rejectDeliveryApplication',
                applicationId: currentApplication.applicationId,
                reason: reason,
                adminUsername: currentUser.username
            })
        });
        
        const result = await response.json();
        
        if(result.success) {
            alert('Solicitud rechazada');
            closeApplicationDetail();
            loadDeliveryApplications();
        } else {
            alert('Error: ' + result.message);
        }
    } catch(error) {
        alert('Error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// GENERAR CÓDIGO DE INVITACIÓN
// ============================================

async function generateNewCode() {
    if(!confirm('¿Generar un nuevo código de invitación?')) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'generateInvitationCode',
                adminUsername: currentUser.username
            })
        });
        
        const result = await response.json();
        
        if(result.success) {
            const expDate = new Date(result.expirationDate).toLocaleDateString('es-MX');
            
            document.getElementById('newCodeResult').innerHTML = `
                <div class="alert alert-success">
                    <h4><i class="fas fa-check-circle"></i> Código Generado Exitosamente</h4>
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 2em; font-weight: bold; color: #667eea; text-align: center; letter-spacing: 3px;">
                            ${result.code}
                        </p>
                        <p style="text-align: center; color: #666; margin-top: 10px;">
                            <i class="fas fa-calendar"></i> Válido hasta: ${expDate}
                        </p>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="copyCode('${result.code}')">
                                <i class="fas fa-copy"></i> Copiar Código
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            loadInvitationCodes();
        } else {
            alert('Error: ' + result.message);
        }
    } catch(error) {
        alert('Error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert('Código copiado al portapapeles: ' + code);
    });
}

// ============================================
// CARGAR CÓDIGOS DE INVITACIÓN
// ============================================

async function loadInvitationCodes() {
    // Esta función se implementaría similar a loadDeliveryApplications
    // Por simplicidad, se deja para que el desarrollador complete
    document.getElementById('codesList').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Los códigos generados se mostrarán aquí
        </div>
    `;
}

// ============================================
// HISTORIAL
// ============================================

function loadApplicationHistory() {
    const processed = allApplications.filter(app => 
        app.status === 'aprobada' || app.status === 'rechazada'
    );
    filterHistory('all');
}

function filterHistory(status) {
    const filtered = status === 'all' ? 
        allApplications.filter(app => app.status !== 'pendiente') :
        allApplications.filter(app => app.status === status);
    
    const container = document.getElementById('historyList');
    
    if(filtered.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay solicitudes en esta categoría
            </div>
        `;
        return;
    }
    
    container.innerHTML = filtered.map(app => {
        const statusClass = app.status === 'aprobada' ? 'status-delivered' : 'status-new';
        const statusIcon = app.status === 'aprobada' ? 'check-circle' : 'times-circle';
        const date = new Date(app.reviewDate).toLocaleDateString('es-MX');
        
        return `
            <div class="order-item">
                <div class="cart-item-header">
                    <h4>${app.fullName}</h4>
                    <span class="order-status ${statusClass}">
                        <i class="fas fa-${statusIcon}"></i> ${app.status}
                    </span>
                </div>
                <div class="cart-item-details">
                    <strong>Usuario:</strong> ${app.username}<br>
                    <strong>Procesado:</strong> ${date}<br>
                    <strong>Por:</strong> ${app.reviewedBy}<br>
                    ${app.notes ? `<strong>Notas:</strong> ${app.notes}<br>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// CSS adicional para document-card
const style = document.createElement('style');
style.textContent = `
    .document-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s;
    }
    
    .document-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .delivery-sub-tab {
        display: none;
    }
    
    .delivery-sub-tab.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    
    .action-section {
        padding: 15px;
        border-radius: 8px;
        background: white;
    }
`;
document.head.appendChild(style);
</script>