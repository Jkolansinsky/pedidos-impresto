<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Repartidor - Centro de Copiado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- ============================================
         SECCIÓN DE LOGIN Y PRE-SOLICITUD
         ============================================ -->
    <div id="loginSection">
        <div class="container" style="max-width: 600px; margin-top: 50px;">
            <div class="header">
                <h1><i class="fas fa-motorcycle"></i> Panel de Repartidor</h1>
                <p>Inicia sesión o solicita tu registro</p>
            </div>
            
            <div class="content">
                <!-- FORMULARIO DE LOGIN -->
                <div id="loginForm">
                    <h3 style="color: #667eea; margin-bottom: 20px;">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </h3>
                    
                    <div class="form-group">
                        <label>Usuario</label>
                        <input type="text" id="username" placeholder="Ingresa tu usuario">
                    </div>
                    
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" id="password" placeholder="Ingresa tu contraseña">
                    </div>
                    
                    <div id="loginError" class="alert alert-error hidden"></div>
                    
                    <button class="btn btn-primary" onclick="login()" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                    
                    <hr style="margin: 30px 0;">
                    
                    <div style="text-align: center;">
                        <p style="color: #666; margin-bottom: 15px;">
                            ¿No tienes cuenta? ¿Quieres ser repartidor?
                        </p>
                        <button class="btn btn-success" onclick="showPreApplication()" style="width: 100%;">
                            <i class="fas fa-user-plus"></i> Solicitar Registro como Repartidor
                        </button>
                    </div>
                </div>
                
                <!-- FORMULARIO DE PRE-SOLICITUD -->
                <div id="preApplicationForm" class="hidden">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="showLogin()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 style="color: #667eea; margin: 0;">
                            <i class="fas fa-clipboard-list"></i> Pre-Solicitud de Registro
                        </h3>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Proceso de Registro:</strong><br>
                            1. Llena este formulario básico<br>
                            2. Espera la revisión del administrador<br>
                            3. Recibirás un código QR en tu teléfono<br>
                            4. Con el código, completa tu registro con documentos<br>
                            5. Después de validación, crea tu usuario y contraseña
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="preFullName" placeholder="Ej: Juan Pérez López">
                    </div>
                    
                    <div class="form-group">
                        <label>Teléfono (WhatsApp) *</label>
                        <input type="tel" id="prePhone" placeholder="9931234567">
                        <small>Recibirás el código QR por WhatsApp a este número</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Correo Electrónico *</label>
                        <input type="email" id="preEmail" placeholder="ejemplo@correo.com">
                    </div>
                    
                    <div class="form-group">
                        <label>¿A qué te dedicas actualmente? *</label>
                        <textarea id="preCurrentJob" rows="3" placeholder="Ej: Estudiante, Comerciante, Empleado, etc."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>¿Por qué quieres ser repartidor? *</label>
                        <textarea id="preMotivation" rows="4" placeholder="Cuéntanos brevemente tus razones..."></textarea>
                    </div>
                    
                    <div id="preAppError" class="alert alert-error hidden"></div>
                    <div id="preAppSuccess" class="alert alert-success hidden"></div>
                    
                    <button class="btn btn-success" onclick="submitPreApplication()" style="width: 100%;">
                        <i class="fas fa-paper-plane"></i> Enviar Pre-Solicitud
                    </button>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <a href="index.html" style="color: #667eea;">
                        <i class="fas fa-arrow-left"></i> Volver al inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         SECCIÓN DE REGISTRO CON QR (SOLO CON TOKEN VÁLIDO)
         ============================================ -->
    <div id="fullRegistrationSection" class="hidden">
        <div class="container" style="max-width: 800px; margin-top: 50px;">
            <div class="header">
                <h1><i class="fas fa-clipboard-check"></i> Registro Completo de Repartidor</h1>
                <p>Completa tu información y sube tus documentos</p>
            </div>
            
            <div class="content">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>¡Tu pre-solicitud fue aprobada!</strong><br>
                        Ahora completa el registro con tus documentos.
                    </div>
                </div>
                
                <!-- Información Recuperada -->
                <div id="recoveredInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Información Registrada
                    </h4>
                    <p><strong>Nombre:</strong> <span id="displayName"></span></p>
                    <p><strong>Teléfono:</strong> <span id="displayPhone"></span></p>
                    <p><strong>Email:</strong> <span id="displayEmail"></span></p>
                </div>
                
                <!-- DOCUMENTOS OBLIGATORIOS -->
                <h3 style="color: #667eea; margin-bottom: 20px;">
                    <i class="fas fa-folder-open"></i> Documentos Obligatorios
                </h3>
                
                <!-- Selfie con INE -->
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Selfie con INE/Credencial *</label>
                    <div class="document-upload-box">
                        <div id="selfiePreview" class="doc-preview hidden">
                            <img id="selfieImg" src="" alt="Selfie">
                            <button class="btn btn-sm btn-danger" onclick="removeDocument('selfie')">
                                <i class="fas fa-times"></i> Eliminar
                            </button>
                        </div>
                        <div id="selfieUpload" class="upload-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>Toma una foto sosteniendo tu INE junto a tu rostro</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="captureDocument('selfie')">
                                    <i class="fas fa-camera"></i> Tomar Foto
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="uploadDocument('selfie')">
                                    <i class="fas fa-upload"></i> Subir Archivo
                                </button>
                            </div>
                            <input type="file" id="selfieFile" accept="image/*" style="display: none;" onchange="handleDocumentUpload('selfie')">
                        </div>
                    </div>
                </div>
                
                <!-- Licencia de Conducir -->
                <div class="form-group">
                    <label><i class="fas fa-id-card-alt"></i> Licencia de Conducir (Vigente) *</label>
                    <div class="document-upload-box">
                        <div id="licensePreview" class="doc-preview hidden">
                            <img id="licenseImg" src="" alt="Licencia">
                            <button class="btn btn-sm btn-danger" onclick="removeDocument('license')">
                                <i class="fas fa-times"></i> Eliminar
                            </button>
                        </div>
                        <div id="licenseUpload" class="upload-placeholder">
                            <i class="fas fa-id-card-alt"></i>
                            <p>Foto clara de ambos lados de tu licencia</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="captureDocument('license')">
                                    <i class="fas fa-camera"></i> Tomar Foto
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="uploadDocument('license')">
                                    <i class="fas fa-upload"></i> Subir Archivo
                                </button>
                            </div>
                            <input type="file" id="licenseFile" accept="image/*,application/pdf" style="display: none;" onchange="handleDocumentUpload('license')">
                        </div>
                    </div>
                </div>
                
                <!-- Tarjeta de Circulación -->
                <div class="form-group">
                    <label><i class="fas fa-car"></i> Tarjeta de Circulación del Vehículo *</label>
                    <div class="document-upload-box">
                        <div id="vehiclePreview" class="doc-preview hidden">
                            <img id="vehicleImg" src="" alt="Tarjeta">
                            <button class="btn btn-sm btn-danger" onclick="removeDocument('vehicle')">
                                <i class="fas fa-times"></i> Eliminar
                            </button>
                        </div>
                        <div id="vehicleUpload" class="upload-placeholder">
                            <i class="fas fa-car"></i>
                            <p>Tarjeta de circulación vigente del vehículo que usarás</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="captureDocument('vehicle')">
                                    <i class="fas fa-camera"></i> Tomar Foto
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="uploadDocument('vehicle')">
                                    <i class="fas fa-upload"></i> Subir Archivo
                                </button>
                            </div>
                            <input type="file" id="vehicleFile" accept="image/*,application/pdf" style="display: none;" onchange="handleDocumentUpload('vehicle')">
                        </div>
                    </div>
                </div>
                
                <!-- Verificación de Antecedentes -->
                <div class="form-group">
                    <label><i class="fas fa-shield-alt"></i> Carta de No Antecedentes Penales *</label>
                    <div class="document-upload-box">
                        <div id="backgroundPreview" class="doc-preview hidden">
                            <img id="backgroundImg" src="" alt="Antecedentes">
                            <button class="btn btn-sm btn-danger" onclick="removeDocument('background')">
                                <i class="fas fa-times"></i> Eliminar
                            </button>
                        </div>
                        <div id="backgroundUpload" class="upload-placeholder">
                            <i class="fas fa-shield-alt"></i>
                            <p>Carta de no antecedentes penales (máximo 3 meses de antigüedad)</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="captureDocument('background')">
                                    <i class="fas fa-camera"></i> Tomar Foto
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="uploadDocument('background')">
                                    <i class="fas fa-upload"></i> Subir Archivo
                                </button>
                            </div>
                            <input type="file" id="backgroundFile" accept="image/*,application/pdf" style="display: none;" onchange="handleDocumentUpload('background')">
                        </div>
                    </div>
                </div>
                
                <div id="fullRegError" class="alert alert-error hidden"></div>
                <div id="fullRegSuccess" class="alert alert-success hidden"></div>
                
                <button class="btn btn-success" onclick="submitFullRegistration()" style="width: 100%; margin-top: 30px;">
                    <i class="fas fa-paper-plane"></i> Enviar Documentos para Validación
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         SECCIÓN DE CREACIÓN DE USUARIO (SOLO CON TOKEN DE APROBACIÓN)
         ============================================ -->
    <div id="createAccountSection" class="hidden">
        <div class="container" style="max-width: 600px; margin-top: 100px;">
            <div class="header">
                <h1><i class="fas fa-user-check"></i> ¡Felicidades!</h1>
                <p>Tu solicitud ha sido aprobada</p>
            </div>
            
            <div class="content">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>¡Has sido aprobado como repartidor!</strong><br>
                        Ahora crea tu usuario y contraseña para acceder al sistema.
                    </div>
                </div>
                
                <div id="approvedInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                    <p><strong>Nombre:</strong> <span id="approvedName"></span></p>
                    <p><strong>Teléfono:</strong> <span id="approvedPhone"></span></p>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 20px;">
                    <i class="fas fa-key"></i> Crea tu Cuenta
                </h3>
                
                <div class="form-group">
                    <label>Nombre de Usuario *</label>
                    <input type="text" id="newUsername" placeholder="Ej: juan.perez" style="text-transform: lowercase;">
                    <small>Mínimo 3 caracteres, sin espacios. Este será tu usuario de acceso.</small>
                </div>
                
                <div class="form-group">
                    <label>Contraseña *</label>
                    <input type="password" id="newPassword" placeholder="Mínimo 6 caracteres">
                </div>
                
                <div class="form-group">
                    <label>Confirmar Contraseña *</label>
                    <input type="password" id="newPasswordConfirm" placeholder="Repite tu contraseña">
                </div>
                
                <div id="createAccountError" class="alert alert-error hidden"></div>
                <div id="createAccountSuccess" class="alert alert-success hidden"></div>
                
                <button class="btn btn-success" onclick="createUserAccount()" style="width: 100%;">
                    <i class="fas fa-check-circle"></i> Crear Mi Cuenta
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         PANEL DE REPARTIDOR (DESPUÉS DEL LOGIN)
         ============================================ -->
    <div id="deliveryPanel" class="hidden">
        <div class="top-header">
            <div class="logo">
                <i class="fas fa-motorcycle"></i> Panel de Repartidor
            </div>
            <div class="user-info">
                <span class="user-badge">
                    <i class="fas fa-motorcycle"></i> <span id="currentUserName"></span>
                </span>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>

        <div class="container">
            <div class="content">
                <h2><i class="fas fa-shipping-fast"></i> Entregas a Domicilio</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="filterDeliveries('ready')">
                        <i class="fas fa-check-circle"></i> Listas para Recoger
                    </button>
                    <button class="btn btn-path" onclick="filterDeliveries('mytaken')">
                        <i class="fas fa-motorcycle"></i> Mis Entregas en Curso
                    </button>
                    <button class="btn btn-secondary" onclick="filterDeliveries('completed')">
                        <i class="fas fa-check-double"></i> Completadas Hoy
                    </button>
                </div>

                <div id="deliveriesList"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Cámara -->
    <div id="cameraModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-camera"></i> Capturar Documento</h3>
                <button class="close-modal" onclick="closeCameraModal()">×</button>
            </div>
            <div style="padding: 20px;">
                <video id="cameraPreview" autoplay style="width: 100%; border-radius: 8px; display: none;"></video>
                <canvas id="captureCanvas" style="display: none;"></canvas>
                <div style="text-align: center; margin-top: 15px;">
                    <button id="startCameraBtn" class="btn btn-primary" onclick="startDocumentCamera()">
                        <i class="fas fa-video"></i> Iniciar Cámara
                    </button>
                    <button id="takePictureBtn" class="btn btn-success hidden" onclick="takeDocumentPicture()">
                        <i class="fas fa-camera-retro"></i> Capturar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Entrega en Curso -->
    <div id="activeDeliveryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-route"></i> Entrega en Curso</h3>
                <button class="close-modal" onclick="closeActiveDelivery()">×</button>
            </div>
            
            <div id="deliveryInfo"></div>

            <div style="margin-top: 20px;">
                <h4><i class="fas fa-map-marked-alt"></i> Ruta de Entrega</h4>
                <div id="deliveryMap" style="height: 400px; border-radius: 8px; overflow: hidden; margin-top: 10px;"></div>
            </div>

            <div class="delivery-controls">
                <h4><i class="fas fa-clipboard-check"></i> Finalizar Entrega</h4>
                <div class="form-group">
                    <label>Comentarios / Observaciones</label>
                    <textarea id="deliveryNotes" rows="3" placeholder="Ej: Cliente recibió conforme, Dejado con portero, etc."></textarea>
                </div>
                <button class="btn btn-success" onclick="completeDelivery()" style="width: 100%;">
                    <i class="fas fa-check-circle"></i> Marcar como Entregado
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p><strong>Procesando...</strong></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="js/config.js"></script>
    <script src="js/repartidor.js"></script>
</body>
</html>
